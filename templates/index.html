<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ANPR Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .navbar { margin-bottom: 24px; }
    .toggle-auto-indicator {
      font-weight: bold;
      color: white;
      background: #198754;
      border: none;
      padding: 0.5rem 1.2rem;
      border-radius: 0.4rem;
      margin-right: 8px;
      cursor: pointer;
    }
    .toggle-auto-off {
      background: #b2b2b2 !important;
      color: #222 !important;
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="/">ANPR Demo</a>
    <div class="ml-auto d-flex align-items-center">
      <button id="btn-auto"
        class="toggle-auto-indicator {{ 'toggle-auto-off' if not auto else '' }}">
        {{ 'T·ª± ƒë·ªông: B·∫¨T' if auto else 'T·ª± ƒë·ªông: T·∫ÆT' }}
      </button>
      <a href="/" class="btn btn-link">Trang ch·ªß</a>
      <a href="/admin" class="btn btn-link">Trang qu·∫£n l√Ω</a>
    </div>
  </nav>

  <div class="container">
    <h2>Nh·∫≠n di·ªán bi·ªÉn s·ªë xe</h2>
    {% if auto %}
      <div class="alert alert-success">
        <b>ƒêang ch·∫°y t·ª± ƒë·ªông:</b> H·ªá th·ªëng t·ª± ƒë·ªông nh·∫≠n di·ªán khi c√≥ ·∫£nh m·ªõi trong th∆∞ m·ª•c <code>images/</code>.
        <div id="auto-log" class="mt-2"></div>
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="mb-4">
      <div class="form-row">
        <div class="col-md-6">
          <label>Ch·ªçn ·∫£nh m·∫´u:</label>
          <select name="image_name" class="form-control" {% if auto %}disabled{% endif %}>
            <option value="">-- Kh√¥ng ch·ªçn --</option>
            {% for fn in images %}
              <option value="{{ fn }}">{{ fn }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label>Ho·∫∑c upload/ch·ª•p ·∫£nh m·ªõi:</label><br>
          <input type="file" name="photo" accept="image/*" class="form-control-file mb-2" {% if auto %}disabled{% endif %}>
          <button type="button" id="camera-btn" class="btn btn-info mb-2">üì∑ Ch·ª•p t·ª´ webcam</button><br>
          <video id="video" width="320" height="240" autoplay style="display:none;"></video><br>
          <button type="button" id="snap" class="btn btn-warning mt-2" style="display:none;">Ch·ª•p ·∫£nh</button>
          <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
        </div>
      </div>
      <button class="btn btn-primary mt-3" {% if auto %}disabled{% endif %}>X·ª≠ l√Ω ·∫£nh</button>
      {% if not auto and plate %}
        <button class="btn btn-success mt-3 ml-2" formaction="/xevao" formmethod="post" name="plate" value="{{ plate }}">Xe v√†o</button>
      {% endif %}
    </form>

    {% if msg %}
      <div class="alert alert-info">{{ msg }}</div>
      {% if plate %}
        <h4>Bi·ªÉn s·ªë: <strong>{{ plate }}</strong></h4>
        <div class="mb-3">
          <img src="{{ url_for('static',filename='processed/11_result.jpg') }}"
               class="img-fluid border" alt="Result">
        </div>
      {% endif %}

      <!-- Lu√¥n hi·ªÉn th·ªã c√°c n√∫t toggle xem c√°c b∆∞·ªõc x·ª≠ l√Ω -->
      <button id="toggle-steps" class="btn btn-secondary mb-2">
        Hi·ªÉn th·ªã c√°c b∆∞·ªõc x·ª≠ l√Ω k·ªπ thu·∫≠t (11 b∆∞·ªõc)
      </button>
      <button id="toggle-logic-steps" class="btn btn-info mb-4 ml-2">
        Hi·ªÉn th·ªã 6 b∆∞·ªõc x·ª≠ l√Ω ch√≠nh
      </button>
      <div id="steps" style="display:none;">
        <div class="row">
          {% for i,label in [
            (1,'resized'),(2,'gray'),(3,'equalize'),
            (4,'bilateral'),(5,'canny'),(6,'contour'),
            (7,'crop'),(8,'denoise'),(9,'thresh'),
            (10,'chars'),(11,'result')
          ] %}
          <div class="col-md-4 mb-3 text-center">
            <p>{{ i }}. {{ label.capitalize() }}</p>
            <img src="{{ url_for('static',filename='processed/{:02d}_{}.jpg'.format(i,label)) }}"
                 class="img-fluid border" alt="{{ label }}">
          </div>
          {% endfor %}
        </div>
      </div>
      <div id="logic-steps" style="display:none;">
        <div class="row">
          {% for i, name, label in [
            (1, 'phat_hien_bien_so', 'Ph√°t hi·ªán v·ªã tr√≠ bi·ªÉn s·ªë'),
            (2, 'cat_phoi_canh', 'C·∫Øt & hi·ªáu ch·ªânh ph·ªëi c·∫£nh'),
            (3, 'nhi_phan_hoa', 'Nh·ªã ph√¢n h√≥a (thresholding)'),
            (4, 'tach_ky_tu', 'T√°ch k√Ω t·ª±'),
            (5, 'ocr_ky_tu', 'Nh·∫≠n d·∫°ng k√Ω t·ª± (OCR)'),
            (6, 'ghep_chuoi', 'Gh√©p chu·ªói bi·ªÉn s·ªë')
          ] %}
          <div class="col-md-4 mb-3 text-center">
            <p>B∆∞·ªõc {{ i }}. {{ label }}</p>
            <img src="{{ url_for('static',filename='processed/L{:02d}_{}.jpg'.format(i, name)) }}"
                 class="img-fluid border" alt="{{ label }}">
          </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>

  <script>
    // L·∫•y tr·∫°ng th√°i auto t·ª´ server
    const autoFlag = "{{ 'true' if auto else 'false' }}";
    // Toggle c√°c b∆∞·ªõc x·ª≠ l√Ω k·ªπ thu·∫≠t
    document.getElementById('toggle-steps')?.addEventListener('click', e => {
      const s=document.getElementById('steps');
      if(s.style.display==='none'){s.style.display='block'; e.target.textContent='·∫®n c√°c b∆∞·ªõc x·ª≠ l√Ω k·ªπ thu·∫≠t (11 b∆∞·ªõc)';}
      else                        {s.style.display='none'; e.target.textContent='Hi·ªÉn th·ªã c√°c b∆∞·ªõc x·ª≠ l√Ω k·ªπ thu·∫≠t (11 b∆∞·ªõc)';}
    });
    // Toggle 6 b∆∞·ªõc logic gi·ªëng b√°o c√°o
    document.getElementById('toggle-logic-steps')?.addEventListener('click', e => {
      const s=document.getElementById('logic-steps');
      if(s.style.display==='none'){s.style.display='block'; e.target.textContent='·∫®n 6 b∆∞·ªõc x·ª≠ l√Ω logic';}
      else                        {s.style.display='none'; e.target.textContent='Hi·ªÉn th·ªã 6 b∆∞·ªõc x·ª≠ l√Ω logic gi·ªëng b√°o c√°o';}
    });
    // Toggle AUTO_MODE
    document.getElementById('btn-auto').addEventListener('click',async ()=>{
      const r = await fetch('/toggle_auto',{method:'POST'});
      location.reload();
    });

    // Webcam capture (lu√¥n ho·∫°t ƒë·ªông ·ªü m·ªçi ch·∫ø ƒë·ªô)
    const video=document.getElementById('video'),
          canvas=document.getElementById('canvas'),
          cameraBtn=document.getElementById('camera-btn'),
          snapBtn=document.getElementById('snap'),
          fileInput=document.querySelector('input[name="photo"]');
    cameraBtn?.addEventListener('click',async()=>{
      try{const s=await navigator.mediaDevices.getUserMedia({video:true});
        video.srcObject=s; video.style.display='block'; snapBtn.style.display='inline-block';}
      catch{alert('Kh√¥ng th·ªÉ truy c·∫≠p webcam');}
    });
    snapBtn?.addEventListener('click',()=>{
      const ctx=canvas.getContext('2d');
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      video.srcObject.getTracks()[0].stop();
      video.style.display='none'; snapBtn.style.display='none';
      canvas.toBlob(blob=>{
        if (autoFlag === "true") {
          fetch('/upload_auto_image', {
            method:'POST',
            body: blob
          }).then(()=>{ alert('ƒê√£ g·ª≠i ·∫£nh v√†o images, t·ª± ƒë·ªông s·∫Ω nh·∫≠n di·ªán!'); });
        } else {
          const f=new File([blob],'capture.jpg',{type:'image/jpeg'});
          const dt=new DataTransfer(); dt.items.add(f);
          fileInput.files=dt.files;
        }
      },'image/jpeg');
    });

    // N·∫øu b·∫≠t t·ª± ƒë·ªông th√¨ li√™n t·ª•c hi·ªÉn th·ªã log bi·ªÉn s·ªë m·ªõi nh·∫•t (AJAX)
    {% if auto %}
    function pollLastAuto(){
      fetch('/get_last_auto')
        .then(res=>res.json())
        .then(obj=>{
          let info = "";
          if(obj.plate) {
            info = `<b>${obj.action}:</b> <span class="text-primary">${obj.plate}</span> l√∫c <b>${obj.time}</b>`;
          } else {
            info = "<i>Ch·ªù ·∫£nh m·ªõi...</i>";
          }
          document.getElementById('auto-log').innerHTML = info;
        });
      setTimeout(pollLastAuto, 2000);
    }
    pollLastAuto();
    {% endif %}
  </script>
</body>
</html>
